package go_srf

import (
	"bytes"
	"encoding/base64"
	"github.com/stretchr/testify/assert"
	"testing"
)

const (
	// some gopher pics
	gopherGif     = "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"
	gopherJpg     = "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"
	gopherPng     = "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"
	randomPayload = "iVBORw0KGgoAAAANSUhEUgAAAEkAAABoCAYAAAC9g91PAAAYyElEQVR42u2deXBd9ZXnP+d3l/f0np42S7IlW/IKxgbLhoBtsBMwaxLSCXQggU5PuqsyTc1MZ2qqqOlK9dT0/DM1k5maVCpT01M1mW4qXdMJ2QidBAJJwEAAG9vY2OAFL3iXjK1dek9vu/f+zvxxn2R5k2RbSWMVv6pXpeXpp3u/96zfc37niaoqH68Jl/kYgo9B+hikj0H6GKSPQfoYpKtbiqKVr+D82ENVsdYyWVTyh45Z3D8cNIrV+AajKGJ4aJhcLktvdzfZbJZcPk9v/wCgOI6hKpEglUpTlUziGpdZDQ1kamuoq6sjnU7jOg4ifxiQ5PcdTIZhSG9fL4ePHKGz80O6iwEnifDSaZKZOqqqa5B0LX6qDqslRCIQB7UQ2YggKCOFAjKSJzcyRKGYQ7KDLHY9Fs6ew3XXXce8eXMxjkFEEOTaACkIixw7epJ3d+9l//AAufomalva8WtrUDWUI0UxULkhIwoCqqAq8c81lsD4xmPltGoRBFFLynPQUols10noOcUNdVWsX7ualqa5iJGPIkgKCCMjI2x7+202Hz5O2L6EmrnzCAXCCERcrLEIFtRUzKFU/taCKKiM/VxVx2yPSPweVWKQUERAxRJZwTceyWCYM4f3Mn9khD+6+z5mz2lGxKASy5Zc9Ir/gCCVy0U2b9rExpMnmXXDJyhX11MiQgAjEt+2ghWwCKKjaiEVg23RceZYZLzSaPzHo19HsZQZY7CihKoYDI5CSEDKBPTs283qpMP99z5AIpGEMOLYsaMcO3GCoaFhampqaGmby/VLluAZB5nEuE0KUhhFnDl9ms7OToqlEs1NzbS2tlBTW4ugdHZ28YNfv0jUcStuzWwiq1gsYHEAU4HDqmJF0FgEiKHTMa92DkgVoMb8mFg8UQqD3eRPniQ9UqImkWAkKDHsJ0jOaaF+zgJGogCr4FkPvzxAcfsmPrVqFa++tw9ZuJhUSxPip7CBku88hXNiH3/ywH20t7dfGUg2snxw9DA/2fg7wnkLSDQ2gOui/XlGPjzF8kRI6+x6XvlwgKaONeTVoOLgmRL5052UT3XT4hqSngMCx4p5qG2kYd58IidFCFgTxsozZotGQRJEQLA4jpI/fIg5/d3c0dHB3PZ5ZDLVGANqIV8ocvz4cV59+x0K8xbhz2mjhBKJksJy5OUXuW7dneQSdahY1NhYkq2Q9oTOLa/wtTW3c8Oy6y8PJFXl5Y0b2ZYrk7p+OTl1EGNwrEVUMW7I4J6dpKoaqVq8mCC0uCJkjx9iYX6AtR0rWDB/Ia7noAJilSgM6R8YZNv27ewslGi4cRU5cQ=="
)

type meta struct {
	RecordName     string `json:"recordName"`
	RecordCategory int    `json:"recordCategory"`
}

type sampleRecord struct {
	RecordType uint16
	Meta       *meta
	Data       []byte
}

func from64(s string) []byte {
	b, err := base64.StdEncoding.DecodeString(s)
	if err != nil {
		panic(err)
	}
	return b
}

func toMeta(name string, category int) *meta {
	return &meta{
		RecordName:     name,
		RecordCategory: category,
	}
}

func testDataset() []sampleRecord {
	return []sampleRecord{
		// meta is empty
		{TypeText, nil, []byte("You're bound to get ideas if you go thinkin' about stuff")},

		// sample meta 1
		{TypeText, toMeta("example record 1", 3), []byte("the quick brown fox jumps over the lazy dog")},

		// sample meta 2
		{TypeJSON, toMeta("example record 2", 7), []byte(`{"recordName":"foo", "recordCategory": 65}`)},

		// meta is empty
		{TypeBinary, nil, from64(randomPayload)},

		// meta not empty
		{TypeBinary, toMeta("random stuff", 99), from64(randomPayload)},

		// gopher gif
		{TypeBinary, toMeta("gopher.gif", 20), from64(gopherGif)},

		// gopher jpg
		{TypeBinary, toMeta("gopher.jpg", 21), from64(gopherJpg)},

		// gopher png
		{TypeBinary, toMeta("gopher.png", 22), from64(gopherPng)},
	}
}

func testReadWrite(t *testing.T, dataset []sampleRecord, compress bool) *bytes.Buffer {
	buf := new(bytes.Buffer)

	// write all records
	for _, r := range dataset {
		err := Write(buf, r.RecordType, r.Data, r.Meta, compress)
		assert.NoError(t, err)
	}

	assert.True(t, buf.Len() > 1024)

	// read all records sequentially, compare with original
	reader := bytes.NewReader(buf.Bytes())
	for _, orig := range dataset {
		r, err := Read(reader)
		assert.NoError(t, err)
		assert.Equal(t, orig.RecordType, r.Type())

		if orig.Meta != nil {
			m := meta{}
			assert.NoError(t, UnpackMeta(r, &m))
			assert.Equal(t, *orig.Meta, m)
		}
		assert.Equal(t, orig.Data, r.Bytes())
	}
	return buf
}

func TestReadWrite(t *testing.T) {
	bufUncompressed := testReadWrite(t, testDataset(), false)
	bufCompressed := testReadWrite(t, testDataset(), true)
	assert.True(t, bufCompressed.Len() < bufUncompressed.Len())
}

func TestReadAll(t *testing.T) {
	orig := testDataset()
	bufUncompressed := testReadWrite(t, orig, false)
	reader := bytes.NewReader(bufUncompressed.Bytes())
	records, err := ReadAll(reader)
	assert.NoError(t, err)
	assert.Len(t, records, len(orig))

	for i, r := range records {
		assert.Equal(t, orig[i].RecordType, r.Type())
		if orig[i].Meta != nil {
			m := meta{}
			assert.NoError(t, UnpackMeta(r, &m))
			assert.Equal(t, *orig[i].Meta, m)
		}
		assert.Equal(t, orig[i].Data, r.Bytes())
	}

	// enable compression
	bufCompressed := testReadWrite(t, testDataset(), true)
	reader = bytes.NewReader(bufCompressed.Bytes())
	records, err = ReadAll(reader)
	assert.NoError(t, err)
	assert.Len(t, records, len(orig))

	for i, r := range records {
		assert.Equal(t, orig[i].RecordType, r.Type())
		if orig[i].Meta != nil {
			m := meta{}
			assert.NoError(t, UnpackMeta(r, &m))
			assert.Equal(t, *orig[i].Meta, m)
		}
		assert.Equal(t, orig[i].Data, r.Bytes())
	}
}

func testWriteRecord(t *testing.T, compress bool) {
	orig := testDataset()
	bufUncompressed := testReadWrite(t, orig, compress)
	reader := bytes.NewReader(bufUncompressed.Bytes())
	records, err := ReadAll(reader)
	assert.NoError(t, err)

	// create new buffer, write records to it
	tmp := new(bytes.Buffer)
	for _, v := range records {
		err = WriteRecord(tmp, v, compress)
		assert.NoError(t, err)
	}

	// read records just written from buffer
	reader = bytes.NewReader(tmp.Bytes())
	records, err = ReadAll(reader)
	assert.NoError(t, err)
	assert.Len(t, records, len(orig))
	for i, r := range records {
		assert.Equal(t, orig[i].RecordType, r.Type())
		if orig[i].Meta != nil {
			m := meta{}
			err = UnpackMeta(r, &m)
			assert.NoError(t, err)
			assert.Equal(t, *orig[i].Meta, m)
		}
		assert.Equal(t, orig[i].Data, r.Bytes())
	}
}

func TestWriteRecordUncompressed(t *testing.T) {
	// test without compression
	testWriteRecord(t, false)
	// test with compression
	testWriteRecord(t, true)
}

func TestUnpackJson(t *testing.T) {
	buf := testReadWrite(t, testDataset(), false)
	// record #3 has json payload
	records, err := ReadAll(bytes.NewReader(buf.Bytes()))
	assert.NoError(t, err)
	m := meta{}
	assert.NoError(t, DecodeJson(records[2], &m))
	assert.Equal(t, "foo", m.RecordName)
	assert.Equal(t, 65, m.RecordCategory)

}
